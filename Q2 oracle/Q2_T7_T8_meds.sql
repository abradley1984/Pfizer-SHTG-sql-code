--For Q1 T7 and T8
--drop table shtg_meds_q1;
--select * from shtg_meds_Q2_d2;
create table shtg_meds_Q2_v2 as
--statins
with pat_list as
         (
             select distinct *
             from SHTG_Q2_STEP3_d5
             where cohort is not null
         )
        ,

     statins as (
         select distinct patid, cohort, 1 as Statin
         from pat_list
                  left join cdm_60_etl.prescribing using (patid) where prescribing.rx_order_Date BETWEEN TO_DATE('09/30/2020', 'MM/DD/YYYY') AND TO_DATE('09/30/2021', 'MM/DD/YYYY')
             and rxnorm_cui in
                 ('83366', '83367', '215567', '596723', '309123', '41127', '72875', '541841', '997007', '1233871', '6472', '352420', '206258', '433849', '997004', '359732', '861612', '2001255', '861652', '2001252', '861634', '2001264', '203144', '323828', '2167558', '301542', '2167563', '213319', '36567', '196503', '312961', '1944257', '1312423', '621590', '1312424', '1312410', '1189805', '593411', '1189809', '1189821', '644112', '791835', '791839', '791846', '327008', '582041', '1372731', '999939', '803516', '1422093', '1422085', '341248', '2535748', '495215', '476351', '904669', '1897', '215436', '904477', '904460', '404914', '750231', '104416', '791831', '791843', '761907', '999935', '7393', '761909', '762970', '1422087', '6574', '904665', '42463', '484211', '1191', '904664', '404773', '597980', '17767', '320864', '859749', '314231', '198211', '313936', '221072', '310405', '687048', '884383', '224938', '197905', '861650', '861646', '861640', '617318', '262095', '617314', '309124', '151972', '360507', '359731', '206257', '433848', '861648', '861643', '2001262', '904483', '904469', '859747', '2167571', '1944262', '104491', '1312417', '1189822', '1372754', '582042', '791834', '757745', '999943', '999946', '763236', '1422098', '2536060', '2535747', '1245449', '476349', '904660', '203333', '750199', '617310', '259255', '617312', '153302', '103919', '197904', '2001260', '904467', '904481', '859753', '859426', '2167557', '2167567', '2167569', '200345', '104490', '152923', '1312415', '1189818', '1189803', '582043', '757733', '1422096', '2536055', '2535750', '1245441', '904661', '597987', '153165', '2001266', '1944734', '859751', '859424', '2167565', '1790679', '1312429', '1189808', '352387', '757748', '999936', '1422101', '2536062', '750203', '153303', '261244', '209013', '2001254', '2001268', '1189827', '1312422', '791838', '999942', '763233', '1422099', '1245420', '597967', '617311', '103918', '1233869', '1233883', '197903', '904458', '904475', '859421', '2167575', '1944264', '312962', '791842', '763228', '763232', '763229', '1422086', '2535749', '2536066', '476345', '750227', '750219', '617320', '309125', '284424', '310404', '1233878', '859419', '1944266', '208220', '1189804', '1312409', '1189814', '763225', '2535745', '597971', '997006', '1233870', '861654', '2167573', '1422095', '1245430', '904668', '597977', '597974', '284764', '1233888', '1312416', '757736', '1422092', '2536064', '476350', '750223')
            OR rxnorm_cui IN
               ('83367', '1422085', '1422101', '341248', '404914', '750224', '597987', '750228', '750231', '750232', '750196', '750236', '750200', '17767', '750204', '83366', '750208', '750212', '104416', '750220', '404773', '597977', '750203', '750215', '1422092', '1422087', '597980', '750216', '750219', '597967', '876514', '597993', '1422086', '1422096', '750235', '750207', '1422098', '597984', '597990', '750211', '750239', '1422093', '153165', '1422095', '404013', '750223', '617310', '404011', '597971', '617318', '750227', '597974', '750199', '1422099')
group by patid, cohort
    )
        ,


-- high_intensity_statins

    high_intensity_statin as (
select distinct patid,
    cohort,
    1 as High_Intensity_Statin,
    rx_frequency,
    RX_DOSE_ORDERED,
    rx_prn_flag,
    rx_days_supply,
    raw_rx_med_name,
    case
    when rxnorm_cui in ('301542',
    '320864',
    '323828',
    '859751',
    '859753',
    '2167558',
    '2167565',
    '2167567',
    '341248',
    '2535745',
    '2535748',
    '2536055',
    '2536062') then 'dose_20'
    when rxnorm_cui in ('83366',
    '83367',
    '153165',
    '617311',
    '617320',
    '259255',
    '262095',
    '301542',
    '320864',
    '323828',
    '859419',
    '859421',
    '2167558',
    '2167569',
    '2167571',
    '1422085',
    '341248',
    '1422087',
    '1422096',
    '1422098',
    '1422099',
    '1422101',
    '2535748',
    '2535749',
    '2536055',
    '2536064',
    '17767',
    '104416',
    '404773',
    '404914',
    '597984',
    '750235',
    '404011',
    '750239',
    '597990',
    '750207',
    '876514',
    '404013',
    '750211',
    '597993',
    '750215') then 'dose_over_40' end as level1
from pat_list
    left join cdm_60_etl.prescribing using (patid)

where prescribing.rx_order_Date BETWEEN TO_DATE('09/30/2020'
    , 'MM/DD/YYYY')
  AND TO_DATE('09/30/2021'
    , 'MM/DD/YYYY')
  and rxnorm_cui in --only including >40 rxnorms right now.
    ('83366'
    , '83367'
    , '153165'
    , '617311'
    , '617320'
    , '259255'
    , '262095'
    , '301542'
    , '320864'
    , '323828'
    , '859419'
    , '859421'
    , '2167558'
    , '2167569'
    , '2167571'
    , '1422085'
    , '341248'
    , '1422087'
    , '1422096'
    , '1422098'
    , '1422099'
    , '1422101'
    , '2535748'
    , '2535749'
    , '2536055'
    , '2536064'
    , '17767'
    , '104416'
    , '404773'
    , '404914'
    , '597984'
    , '750235'
    , '404011'
    , '750239'
    , '597990'
    , '750207'
    , '876514'
    , '404013'
    , '750211'
    , '597993'
    , '750215')
    )
    ,
    /*('83366', '83367', '320864', '859421', '2167558', '1422087', '2536062', '404011', '597990', '750211', '259255', '262095', '301542', '859419', '323828', '341248', '104416', '404914', '153165', '2167565', '1422099', '404773', '750207', '17767', '617311', '859751', '2167567', '1422101', '876514', '617320', '859753', '750239', '1422096', '2535748', '597984', '2167569', '1422098', '2535749', '750235', '2167571', '1422085', '2535745', '2536055', '2536064', '404013', '597993', '750215')*/


-- ezetimibe
    ezetimibe as (
select distinct patid, cohort, 1 as Ezetimibe
from pat_list
    left join cdm_60_etl.prescribing using (patid)

where prescribing.rx_order_Date BETWEEN TO_DATE('09/30/2020'
    , 'MM/DD/YYYY')
  AND TO_DATE('09/30/2021'
    , 'MM/DD/YYYY')
  and rxnorm_cui in
    ('1422085'
    , '341248'
    , '1422098'
    , '301542'
    , '2535748'
    , '2536055'
    , '476345'
    , '36567'
    , '495215'
    , '2282403'
    , '2283229'
    , '2283231'
    , '2283236'
    , '2283230'
    , '349556'
    , '352304'
    , '353099'
    , '83366'
    , '1422087'
    , '323828'
    , '2535749'
    , '2536066'
    , '484211'
    , '476351'
    , '83367'
    , '1422096'
    , '2536060'
    , '1245430'
    , '1422095'
    , '2535745'
    , '2536064'
    , '1245420'
    , '1422093'
    , '476350'
    , '1422086'
    , '1422092'
    , '1422099'
    , '2536062'
    , '2535750'
    , '476349'
    , '1245441'
    , '1422101'
    , '2535747'
    , '1245449')
group by patid, cohort),

--bile_acid_sequestrant
    bile_acid_sequestrant as (
select distinct patid, cohort, 1 as bile_acid_sequestrant
from pat_list
    left join cdm_60_etl.prescribing using (patid)

where prescribing.rx_order_Date BETWEEN TO_DATE('09/30/2020'
    , 'MM/DD/YYYY')
  AND TO_DATE('09/30/2021'
    , 'MM/DD/YYYY')
  and rxnorm_cui in
    ('202582'
    , '848949'
    , '848943'
    , '1801279'
    , '2447'
    , '1801280'
    , '848951'
    , '141625'
    , '104485'
    , '2685'
    , '151533'
    , '10159'
    , '848946'
    , '1311524'
    , '219397'
    , '93918'
    , '284918'
    , '866907'
    , '218059'
    , '141626'
    , '866905'
    , '1048452'
    , '1048450'
    , '218060'
    , '866910'
    , '866912'
    , '1048447'
    , '1048445')
group by patid, cohort),


--fibrate
    fibrate as (
select distinct patid, cohort, 1 as fibrate
from pat_list
    left join cdm_60_etl.prescribing using (patid)

where prescribing.rx_order_Date BETWEEN TO_DATE('09/30/2020'
    , 'MM/DD/YYYY')
  AND TO_DATE('09/30/2021'
    , 'MM/DD/YYYY')
  and rxnorm_cui in
    ('8703'
    , '578784'
    , '220456'
    , '352747'
    , '351133'
    , '477562'
    , '583110'
    , '1442170'
    , '583093'
    , '225591'
    , '310288'
    , '477560'
    , '221100'
    , '197522'
    , '603834'
    , '351909'
    , '201517'
    , '483427'
    , '1442163'
    , '349287'
    , '352031'
    , '544518'
    , '352744'
    , '261295'
    , '200311'
    , '1442165'
    , '352030'
    , '615906'
    , '310289'
    , '213276'
    , '603836'
    , '351842'
    , '763253'
    , '1442168'
    , '261357'
    , '540281'
    , '2594'
    , '616852'
    , '763247'
    , '577031'
    , '578799'
    , '749804'
    , '749802'
    , '483425'
    , '351898'
    , '583096'
    , '702169'
    , '404348'
    , '226346'
    , '616853'
    , '702055'
    , '763252'
    , '763250'
    , '578797'
    , '583122'
    , '151389'
    , '763258'
    , '763256'
    , '583113'
    , '103920')
group by patid, cohort)
        ,


--icosapent_ethyl
    icosapent_ethyl as (
select distinct patid, cohort, 1 as icosapent_ethyl
from pat_list
    left join cdm_60_etl.prescribing using (patid)

where prescribing.rx_order_Date BETWEEN TO_DATE('09/30/2020'
    , 'MM/DD/YYYY')
  AND TO_DATE('09/30/2021'
    , 'MM/DD/YYYY')
  and rxnorm_cui in
    ('90'
    , '1304979'
    , '4419'
    , '1811182'
    , '1304980'
    , '1811180'
    , '1304985'
    , '1304974')
group by patid, cohort),


--niacin
    niacin as (
select distinct patid, cohort, 1 as niacin
from pat_list
    left join cdm_60_etl.prescribing using (patid)

where prescribing.rx_order_Date BETWEEN TO_DATE('09/30/2020'
    , 'MM/DD/YYYY')
  AND TO_DATE('09/30/2021'
    , 'MM/DD/YYYY')
  and rxnorm_cui in
    ('7393'
    , '346366'
    , '215511'
    , '1088776'
    , '218731'
    , '202711'
    , '218729'
    , '211683'
    , '202713'
    , '218733'
    , '247747'
    , '215526'
    , '314131'
    , '311958'
    , '311960'
    , '219957'
    , '311946'
    , '212579'
    , '311963'
    , '27604'
    , '791831'
    , '791835'
    , '791843'
    , '582041'
    , '2001487'
    , '763228'
    , '803516'
    , '1372731'
    , '763232'
    , '36567'
    , '763229'
    , '311959'
    , '218728'
    , '582042'
    , '1007270'
    , '6472'
    , '327008'
    , '2001486'
    , '2001475'
    , '260852'
    , '198760'
    , '211684'
    , '198024'
    , '317015'
    , '207664'
    , '791834'
    , '791839'
    , '757745'
    , '32863'
    , '763225'
    , '999935'
    , '999942'
    , '761909'
    , '205247'
    , '207663'
    , '198759'
    , '311951'
    , '647346'
    , '1098135'
    , '1088779'
    , '2001480'
    , '352387'
    , '757736'
    , '999943'
    , '999946'
    , '999936'
    , '311944'
    , '1098134'
    , '207662'
    , '791846'
    , '791842'
    , '757733'
    , '763233'
    , '311955'
    , '2001474'
    , '200015'
    , '881376'
    , '644112'
    , '791838'
    , '582043'
    , '763236'
    , '1098144'
    , '212576'
    , '796544'
    , '2001492'
    , '761907'
    , '1098143'
    , '199143'
    , '2001472'
    , '311949'
    , '11358'
    , '236738'
    , '757748'
    , '762970'
    , '1098141'
    , '213275'
    , '89795'
    , '999939'
    , '1098142'
    , '212577'
    , '212578'
    , '211682'
    , '311945'
    , '2121691'
    , '7414'
    , '235354')
group by patid, cohort),


--omega_3
    omega_3 as (
select distinct patid, cohort, 1 as omega_3
from pat_list
    left join cdm_60_etl.prescribing using (patid)

where prescribing.rx_order_Date BETWEEN TO_DATE('09/30/2020'
    , 'MM/DD/YYYY')
  AND TO_DATE('09/30/2021'
    , 'MM/DD/YYYY')
  and rxnorm_cui in
    ('4511'
    , '144450'
    , '452601'
    , '1426444'
    , '1314214'
    , '4885'
    , '9060'
    , '259265'
    , '21406'
    , '1151'
    , '999536'
    , '1193036'
    , '607044'
    , '60761'
    , '24941'
    , '90'
    , '4301'
    , '9641'
    , '1895'
    , '476847'
    , '90176'
    , '317841'
    , '11246'
    , '1008282'
    , '684879'
    , '11359'
    , '1310463'
    , '236608'
    , '89905'
    , '968498'
    , '11416'
    , '203164'
    , '278346'
    , '577208'
    , '39918'
    , '236871'
    , '23247'
    , '659476'
    , '11256'
    , '484348'
    , '5463'
    , '24942'
    , '283579'
    , '8310'
    , '11248'
    , '4845'
    , '283567'
    , '19143'
    , '1114513'
    , '999533'
    , '18451'
    , '259274'
    , '4509'
    , '880350'
    , '260019'
    , '4847'
    , '253172'
    , '9906'
    , '236809'
    , '830736'
    , '1193041'
    , '1302206'
    , '237116'
    , '2837'
    , '2418'
    , '1193046'
    , '236649'
    , '9346'
    , '1193037'
    , '1302201')
group by patid, cohort),


--pcsk9
    pcsk9 as (
select distinct patid, cohort, 1 as pcsk9
from pat_list
    left join cdm_60_etl.prescribing using (patid)

where prescribing.rx_order_Date BETWEEN TO_DATE('09/30/2020'
    , 'MM/DD/YYYY')
  AND TO_DATE('09/30/2021'
    , 'MM/DD/YYYY')
  and rxnorm_cui in
    ('1659152'
    , '1659183'
    , '1659157'
    , '1801322'
    , '1665684'
    , '1665896'
    , '1659156'
    , '1659177'
    , '1665904'
    , '1659161'
    , '1659179'
    , '1659182'
    , '1665906'
    , '1801319'
    , '1665895'
    , '1659165'
    , '1665900'
    , '1659167')
group by patid, cohort)
        ,
    first_therapy_date as (
select patid, cohort, min (prescribing.rx_order_Date) as first_therapy_date

from pat_list
    left join cdm_60_etl.prescribing using (patid)
where rxnorm_cui in
    ('1007270'
    , '1008282'
    , '10159'
    , '103918'
    , '103919'
    , '103920'
    , '104416'
    , '104485'
    , '104490'
    , '104491'
    , '1048445'
    , '1048447'
    , '1048450'
    , '1048452'
    , '1088776'
    , '1088779'
    , '1098134'
    , '1098135'
    , '1098141'
    , '1098142'
    , '1098143'
    , '1098144'
    , '1114513'
    , '11246'
    , '11248'
    , '11256'
    , '11358'
    , '11359'
    , '11416'
    , '1151'
    , '1189803'
    , '1189804'
    , '1189805'
    , '1189808'
    , '1189809'
    , '1189814'
    , '1189818'
    , '1189821'
    , '1189822'
    , '1189827'
    , '1191'
    , '1193036'
    , '1193037'
    , '1193041'
    , '1193046'
    , '1233869'
    , '1233870'
    , '1233871'
    , '1233878'
    , '1233883'
    , '1233888'
    , '1245420'
    , '1245430'
    , '1245441'
    , '1245449'
    , '1302201'
    , '1302206'
    , '1304974'
    , '1304979'
    , '1304980'
    , '1304985'
    , '1310463'
    , '1311524'
    , '1312409'
    , '1312410'
    , '1312415'
    , '1312416'
    , '1312417'
    , '1312422'
    , '1312423'
    , '1312424'
    , '1312429'
    , '1314214'
    , '1372731'
    , '1372754'
    , '141625'
    , '141626'
    , '1422085'
    , '1422086'
    , '1422087'
    , '1422092'
    , '1422093'
    , '1422095'
    , '1422096'
    , '1422098'
    , '1422099'
    , '1422101'
    , '1426444'
    , '1442163'
    , '1442165'
    , '1442168'
    , '1442170'
    , '144450'
    , '151389'
    , '151533'
    , '151972'
    , '152923'
    , '153165'
    , '153302'
    , '153303'
    , '1659152'
    , '1659156'
    , '1659157'
    , '1659161'
    , '1659165'
    , '1659167'
    , '1659177'
    , '1659179'
    , '1659182'
    , '1659183'
    , '1665684'
    , '1665895'
    , '1665896'
    , '1665900'
    , '1665904'
    , '1665906'
    , '17767'
    , '1790679'
    , '1801279'
    , '1801280'
    , '1801319'
    , '1801322'
    , '1811180'
    , '1811182'
    , '18451'
    , '1895'
    , '1897'
    , '19143'
    , '1944257'
    , '1944262'
    , '1944264'
    , '1944266'
    , '1944734'
    , '196503'
    , '197522'
    , '197903'
    , '197904'
    , '197905'
    , '198024'
    , '198211'
    , '198759'
    , '198760'
    , '199143'
    , '200015'
    , '2001252'
    , '2001254'
    , '2001255'
    , '2001260'
    , '2001262'
    , '2001264'
    , '2001266'
    , '2001268'
    , '2001472'
    , '2001474'
    , '2001475'
    , '2001480'
    , '2001486'
    , '2001487'
    , '2001492'
    , '200311'
    , '200345'
    , '201517'
    , '202582'
    , '202711'
    , '202713'
    , '203144'
    , '203164'
    , '203333'
    , '205247'
    , '206257'
    , '206258'
    , '207662'
    , '207663'
    , '207664'
    , '208220'
    , '209013'
    , '211682'
    , '211683'
    , '211684'
    , '2121691'
    , '212576'
    , '212577'
    , '212578'
    , '212579'
    , '213275'
    , '213276'
    , '213319'
    , '21406'
    , '215436'
    , '215511'
    , '215526'
    , '215567'
    , '2167557'
    , '2167558'
    , '2167563'
    , '2167565'
    , '2167567'
    , '2167569'
    , '2167571'
    , '2167573'
    , '2167575'
    , '218059'
    , '218060'
    , '218728'
    , '218729'
    , '218731'
    , '218733'
    , '219397'
    , '219957'
    , '220456'
    , '221072'
    , '221100'
    , '221100'
    ,--fibrate,
    '224938'
    , '225591'
    , '226346'
    , '23247'
    , '235354'
    , '236608'
    , '236649'
    , '236738'
    , '236809'
    , '236871'
    , '237116'
    , '2418'
    , '2447'
    , '2447'
    ,--bile acid,
    '247747'
    , '24941'
    , '24942'
    , '253172'
    , '2535745'
    , '2535747'
    , '2535748'
    , '2535749'
    , '2535750'
    , '2536055'
    , '2536060'
    , '2536062'
    , '2536064'
    , '2536066'
    , '259255'
    , '259265'
    , '259274'
    , '2594'
    , '260019'
    , '260852'
    , '261244'
    , '261295'
    , '261357'
    , '262095'
    , '2685'
    , '27604'
    , '278346'
    , '283567'
    , '283579'
    , '2837'
    , '284424'
    , '284764'
    , '284918'
    , '301542'
    , '309123'
    , '309124'
    , '309125'
    , '310288'
    , '310289'
    , '310404'
    , '310405'
    , '311944'
    , '311945'
    , '311946'
    , '311949'
    , '311951'
    , '311955'
    , '311958'
    , '311959'
    , '311960'
    , '311963'
    , '312961'
    , '312962'
    , '313936'
    , '314131'
    , '314231'
    , '317015'
    , '317841'
    , '320864'
    , '323828'
    , '327008'
    , '32863'
    , '341248'
    , '346366'
    , '346366'
    , --niacin,
    '349287'
    , '351133'
    , '351842'
    , '351898'
    , '351909'
    , '352030'
    , '352031'
    , '352387'
    , '352420'
    , '352744'
    , '352747'
    , '359731'
    , '359732'
    , '360507'
    , '36567'
    , '39918'
    , '404011'
    , '404013'
    , '404348'
    , '404773'
    , '404914'
    , '41127'
    , '42463'
    , '4301'
    , '433848'
    , '433849'
    , '4419'
    , '4419'
    , --icoethyl,
    '4509'
    , '4511'
    , '452601'
    , '476345'
    , '476349'
    , '476350'
    , '476351'
    , '476847'
    , '477560'
    , '477562'
    , '483425'
    , '483427'
    , '484211'
    , '484348'
    , '484348'
    ,--omega3,
    '4845'
    , '4847'
    , '4885'
    , '495215'
    , '495215'
    ,--ezetimibe,
    '540281'
    , '541841'
    , '544518'
    , '5463'
    , '577031'
    , '577208'
    , '578784'
    , '578797'
    , '578799'
    , '582041'
    , '582042'
    , '582043'
    , '583093'
    , '583096'
    , '583110'
    , '583113'
    , '583122'
    , '593411'
    , '596723'
    , '597967'
    , '597971'
    , '597974'
    , '597977'
    , '597980'
    , '597984'
    , '597987'
    , '597990'
    , '597993'
    , '603834'
    , '603836'
    , '607044'
    , '60761'
    , '615906'
    , '616852'
    , '616853'
    , '617310'
    , '617311'
    , '617312'
    , '617314'
    , '617318'
    , '617320'
    , '621590'
    , '644112'
    , '6472'
    , '647346'
    , '6574'
    , '659476'
    , '684879'
    , '687048'
    , '702055'
    , '702169'
    , '72875'
    , '7393'
    , '7414'
    , '749802'
    , '749804'
    , '750196'
    , '750199'
    , '750200'
    , '750203'
    , '750204'
    , '750207'
    , '750208'
    , '750211'
    , '750212'
    , '750215'
    , '750216'
    , '750219'
    , '750220'
    , '750223'
    , '750224'
    , '750227'
    , '750228'
    , '750231'
    , '750232'
    , '750235'
    , '750236'
    , '750239'
    , '757733'
    , '757736'
    , '757745'
    , '757748'
    , '761907'
    , '761909'
    , '762970'
    , '763225'
    , '763228'
    , '763229'
    , '763232'
    , '763233'
    , '763236'
    , '763247'
    , '763250'
    , '763252'
    , '763253'
    , '763256'
    , '763258'
    , '791831'
    , '791834'
    , '791835'
    , '791838'
    , '791839'
    , '791842'
    , '791843'
    , '791846'
    , '796544'
    , '803516'
    , '830736'
    , '8310'
    , '83366'
    , '83367'
    , '848943'
    , '848946'
    , '848949'
    , '848951'
    , '859419'
    , '859421'
    , '859424'
    , '859426'
    , '859747'
    , '859749'
    , '859751'
    , '859753'
    , '861612'
    , '861634'
    , '861640'
    , '861643'
    , '861646'
    , '861648'
    , '861650'
    , '861652'
    , '861654'
    , '866905'
    , '866907'
    , '866910'
    , '866912'
    , '8703'
    , '876514'
    , '880350'
    , '881376'
    , '884383'
    , '89795'
    , '89905'
    , '90'
    , '90176'
    , '904458'
    , '904460'
    , '904467'
    , '904469'
    , '904475'
    , '904477'
    , '904481'
    , '904483'
    , '904660'
    , '904661'
    , '904664'
    , '904665'
    , '904668'
    , '904669'
    , '9060'
    , '9346'
    , '93918'
    , '9641'
    , '968498'
    , '9906'
    , '997004'
    , '997006'
    , '997007'
    , '999533'
    , '999536'
    , '999935'
    , '999936'
    , '999939'
    , '999942'
    , '999943'
    , '999946'
    , '1659152'
    , '7393'
    )
group by patid, cohort)
        ,
    last_therapy_date as (
select patid, cohort, max (prescribing.rx_order_Date) as last_therapy_date_in_sp

from pat_list
    left join cdm_60_etl.prescribing using (patid)
where prescribing.rx_order_Date BETWEEN TO_DATE('09/30/2020'
    , 'MM/DD/YYYY')
  AND TO_DATE('09/30/2021'
    , 'MM/DD/YYYY')
  and rxnorm_cui in
    ('1007270'
    , '1008282'
    , '10159'
    , '103918'
    , '103919'
    , '103920'
    , '104416'
    , '104485'
    , '104490'
    , '104491'
    , '1048445'
    , '1048447'
    , '1048450'
    , '1048452'
    , '1088776'
    , '1088779'
    , '1098134'
    , '1098135'
    , '1098141'
    , '1098142'
    , '1098143'
    , '1098144'
    , '1114513'
    , '11246'
    , '11248'
    , '11256'
    , '11358'
    , '11359'
    , '11416'
    , '1151'
    , '1189803'
    , '1189804'
    , '1189805'
    , '1189808'
    , '1189809'
    , '1189814'
    , '1189818'
    , '1189821'
    , '1189822'
    , '1189827'
    , '1191'
    , '1193036'
    , '1193037'
    , '1193041'
    , '1193046'
    , '1233869'
    , '1233870'
    , '1233871'
    , '1233878'
    , '1233883'
    , '1233888'
    , '1245420'
    , '1245430'
    , '1245441'
    , '1245449'
    , '1302201'
    , '1302206'
    , '1304974'
    , '1304979'
    , '1304980'
    , '1304985'
    , '1310463'
    , '1311524'
    , '1312409'
    , '1312410'
    , '1312415'
    , '1312416'
    , '1312417'
    , '1312422'
    , '1312423'
    , '1312424'
    , '1312429'
    , '1314214'
    , '1372731'
    , '1372754'
    , '141625'
    , '141626'
    , '1422085'
    , '1422086'
    , '1422087'
    , '1422092'
    , '1422093'
    , '1422095'
    , '1422096'
    , '1422098'
    , '1422099'
    , '1422101'
    , '1426444'
    , '1442163'
    , '1442165'
    , '1442168'
    , '1442170'
    , '144450'
    , '151389'
    , '151533'
    , '151972'
    , '152923'
    , '153165'
    , '153302'
    , '153303'
    , '1659152'
    , '1659156'
    , '1659157'
    , '1659161'
    , '1659165'
    , '1659167'
    , '1659177'
    , '1659179'
    , '1659182'
    , '1659183'
    , '1665684'
    , '1665895'
    , '1665896'
    , '1665900'
    , '1665904'
    , '1665906'
    , '17767'
    , '1790679'
    , '1801279'
    , '1801280'
    , '1801319'
    , '1801322'
    , '1811180'
    , '1811182'
    , '18451'
    , '1895'
    , '1897'
    , '19143'
    , '1944257'
    , '1944262'
    , '1944264'
    , '1944266'
    , '1944734'
    , '196503'
    , '197522'
    , '197903'
    , '197904'
    , '197905'
    , '198024'
    , '198211'
    , '198759'
    , '198760'
    , '199143'
    , '200015'
    , '2001252'
    , '2001254'
    , '2001255'
    , '2001260'
    , '2001262'
    , '2001264'
    , '2001266'
    , '2001268'
    , '2001472'
    , '2001474'
    , '2001475'
    , '2001480'
    , '2001486'
    , '2001487'
    , '2001492'
    , '200311'
    , '200345'
    , '201517'
    , '202582'
    , '202711'
    , '202713'
    , '203144'
    , '203164'
    , '203333'
    , '205247'
    , '206257'
    , '206258'
    , '207662'
    , '207663'
    , '207664'
    , '208220'
    , '209013'
    , '211682'
    , '211683'
    , '211684'
    , '2121691'
    , '212576'
    , '212577'
    , '212578'
    , '212579'
    , '213275'
    , '213276'
    , '213319'
    , '21406'
    , '215436'
    , '215511'
    , '215526'
    , '215567'
    , '2167557'
    , '2167558'
    , '2167563'
    , '2167565'
    , '2167567'
    , '2167569'
    , '2167571'
    , '2167573'
    , '2167575'
    , '218059'
    , '218060'
    , '218728'
    , '218729'
    , '218731'
    , '218733'
    , '219397'
    , '219957'
    , '220456'
    , '221072'
    , '221100'
    , '221100'
    ,--fibrate,
    '224938'
    , '225591'
    , '226346'
    , '23247'
    , '235354'
    , '236608'
    , '236649'
    , '236738'
    , '236809'
    , '236871'
    , '237116'
    , '2418'
    , '2447'
    , '2447'
    ,--bile acid,
    '247747'
    , '24941'
    , '24942'
    , '253172'
    , '2535745'
    , '2535747'
    , '2535748'
    , '2535749'
    , '2535750'
    , '2536055'
    , '2536060'
    , '2536062'
    , '2536064'
    , '2536066'
    , '259255'
    , '259265'
    , '259274'
    , '2594'
    , '260019'
    , '260852'
    , '261244'
    , '261295'
    , '261357'
    , '262095'
    , '2685'
    , '27604'
    , '278346'
    , '283567'
    , '283579'
    , '2837'
    , '284424'
    , '284764'
    , '284918'
    , '301542'
    , '309123'
    , '309124'
    , '309125'
    , '310288'
    , '310289'
    , '310404'
    , '310405'
    , '311944'
    , '311945'
    , '311946'
    , '311949'
    , '311951'
    , '311955'
    , '311958'
    , '311959'
    , '311960'
    , '311963'
    , '312961'
    , '312962'
    , '313936'
    , '314131'
    , '314231'
    , '317015'
    , '317841'
    , '320864'
    , '323828'
    , '327008'
    , '32863'
    , '341248'
    , '346366'
    , '346366'
    , --niacin,
    '349287'
    , '351133'
    , '351842'
    , '351898'
    , '351909'
    , '352030'
    , '352031'
    , '352387'
    , '352420'
    , '352744'
    , '352747'
    , '359731'
    , '359732'
    , '360507'
    , '36567'
    , '39918'
    , '404011'
    , '404013'
    , '404348'
    , '404773'
    , '404914'
    , '41127'
    , '42463'
    , '4301'
    , '433848'
    , '433849'
    , '4419'
    , '4419'
    , --icoethyl,
    '4509'
    , '4511'
    , '452601'
    , '476345'
    , '476349'
    , '476350'
    , '476351'
    , '476847'
    , '477560'
    , '477562'
    , '483425'
    , '483427'
    , '484211'
    , '484348'
    , '484348'
    ,--omega3,
    '4845'
    , '4847'
    , '4885'
    , '495215'
    , '495215'
    ,--ezetimibe,
    '540281'
    , '541841'
    , '544518'
    , '5463'
    , '577031'
    , '577208'
    , '578784'
    , '578797'
    , '578799'
    , '582041'
    , '582042'
    , '582043'
    , '583093'
    , '583096'
    , '583110'
    , '583113'
    , '583122'
    , '593411'
    , '596723'
    , '597967'
    , '597971'
    , '597974'
    , '597977'
    , '597980'
    , '597984'
    , '597987'
    , '597990'
    , '597993'
    , '603834'
    , '603836'
    , '607044'
    , '60761'
    , '615906'
    , '616852'
    , '616853'
    , '617310'
    , '617311'
    , '617312'
    , '617314'
    , '617318'
    , '617320'
    , '621590'
    , '644112'
    , '6472'
    , '647346'
    , '6574'
    , '659476'
    , '684879'
    , '687048'
    , '702055'
    , '702169'
    , '72875'
    , '7393'
    , '7414'
    , '749802'
    , '749804'
    , '750196'
    , '750199'
    , '750200'
    , '750203'
    , '750204'
    , '750207'
    , '750208'
    , '750211'
    , '750212'
    , '750215'
    , '750215'
    , --high intensity statin,
    '750215'
    ,--statins,
    '750216'
    , '750219'
    , '750220'
    , '750223'
    , '750224'
    , '750227'
    , '750228'
    , '750231'
    , '750232'
    , '750235'
    , '750236'
    , '750239'
    , '757733'
    , '757736'
    , '757745'
    , '757748'
    , '761907'
    , '761909'
    , '762970'
    , '763225'
    , '763228'
    , '763229'
    , '763232'
    , '763233'
    , '763236'
    , '763247'
    , '763250'
    , '763252'
    , '763253'
    , '763256'
    , '763258'
    , '791831'
    , '791834'
    , '791835'
    , '791838'
    , '791839'
    , '791842'
    , '791843'
    , '791846'
    , '796544'
    , '803516'
    , '830736'
    , '8310'
    , '83366'
    , '83367'
    , '848943'
    , '848946'
    , '848949'
    , '848951'
    , '859419'
    , '859421'
    , '859424'
    , '859426'
    , '859747'
    , '859749'
    , '859751'
    , '859753'
    , '861612'
    , '861634'
    , '861640'
    , '861643'
    , '861646'
    , '861648'
    , '861650'
    , '861652'
    , '861654'
    , '866905'
    , '866907'
    , '866910'
    , '866912'
    , '8703'
    , '876514'
    , '880350'
    , '881376'
    , '884383'
    , '89795'
    , '89905'
    , '90'
    , '90176'
    , '904458'
    , '904460'
    , '904467'
    , '904469'
    , '904475'
    , '904477'
    , '904481'
    , '904483'
    , '904660'
    , '904661'
    , '904664'
    , '904665'
    , '904668'
    , '904669'
    , '9060'
    , '9346'
    , '93918'
    , '9641'
    , '968498'
    , '9906'
    , '997004'
    , '997006'
    , '997007'
    , '999533'
    , '999536'
    , '999935'
    , '999936'
    , '999939'
    , '999942'
    , '999943'
    , '999946'
    , '1659152'
    , '7393'
    )
group by patid, cohort)
        ,
    all_meds as (
select distinct patid,
    pat_list.cohort,
    ldl_result_num,
    nhdl,
    TG_result_num,
    -- LDL_category,
    LDL_category2,
    TG_category,
    --nhdl_category2,
    nhdl_category2,
    Statin,
    High_Intensity_Statin,
    Ezetimibe,
    bile_acid_sequestrant,
    fibrate,
    pcsk9,
    omega_3,
    niacin,
    icosapent_ethyl,
    first_therapy_date,
    last_therapy_date_in_sp
from pat_list
    full outer join high_intensity_statin using (patid)
    full outer join statins using (patid)
    full outer join ezetimibe using (patid)
    full outer join bile_acid_sequestrant using (patid)
    full outer join fibrate using (patid)
    full outer join pcsk9 using (patid)
    full outer join omega_3 using (patid)
    full outer join niacin using (patid)
    full outer join icosapent_ethyl using (patid)
    full outer join first_therapy_date using (patid)
    full outer join last_therapy_date using (patid)
order by pat_list.cohort)
        ,
    all_meds_with_labs as (
SELECT distinct patid,
    cohort,
    coalesce (Ezetimibe, bile_acid_sequestrant, fibrate, pcsk9, icosapent_ethyl, niacin, omega_3,
    0) as other_lipid_lowering,
    case
    when (coalesce (statin, Ezetimibe, bile_acid_sequestrant, fibrate, pcsk9, icosapent_ethyl,
    niacin, omega_3, 0)) = 0
    then 1 end as no_lipid_lowering,
    case
    when (coalesce (statin, Ezetimibe, bile_acid_sequestrant, fibrate, pcsk9, icosapent_ethyl,
    niacin, 0)) = 0
    then 1 end as no_lipid_lowering_ex_omega,
    coalesce (Ezetimibe, bile_acid_sequestrant, fibrate, pcsk9, icosapent_ethyl, niacin,
    0) as other_lipid_lowering_ex_omega,
    Statin,
    High_Intensity_Statin,
    Ezetimibe,
    bile_acid_sequestrant,
    fibrate,
    pcsk9,
    omega_3,
    niacin,
    icosapent_ethyl,
    first_therapy_date,
    last_therapy_date_in_sp,
    case when LDL_result_num >= 100 then 1 else 0 end as ldl_above_100,
    case when LDL_result_num >= 70 then 1 else 0 end as ldl_above_70,
    case when (LDL_result_num < 70 and nhdl >= 100) then 1 else 0 end as ldl_under_70_nhdl_above_100,
    case when (LDL_result_num < 70 and nhdl >= 100 and TG_result_num >= 150) then 1 else 0 end as ldl_under_70_nhdl_above_100_TG_above_150,
    case when nhdl >= 100 then 1 else 0 end as nhdl_above_100,
    case when nhdl >= 130 then 1 else 0 end as nhdl_above_130,
    case when TG_result_num >= 150 then 1 else 0 end as TG_above_150,
    case
    when (last_therapy_date_in_sp - first_therapy_date < 90) then 1
    else 0 end as less_than_3_months_therapy

FROM all_meds)

select *
from all_meds_with_labs;

--table 7
select cohort,
       count(distinct patid)                                                      as total_count,
       sum(Statin)                                                                   Statin,
       sum(High_Intensity_Statin)                                                    High_Intensity_Statin,
       sum(Ezetimibe)                                                                Ezetimibe,
       sum(bile_acid_sequestrant)                                                    bile_acid_sequestrant,
       sum(fibrate)                                                                  fibrate,
       sum(pcsk9)                                                                    pcsk9,
       sum(omega_3)                                                                  omega_3,
       sum(niacin)                                                                   niacin,
       sum(icosapent_ethyl)                                                          icosapent_ethyl,
       sum(case when Statin = 1 and Ezetimibe = 1 then 1 end)                     as statin_ezetimibe,
       sum(case when Statin = 1 and other_lipid_lowering = 1 then 1 end)          as statin_plus_other_lipid_l,

       sum(no_lipid_lowering)                                                     as no_lipid_lowering,--,--, ldl_above_70
       sum(case when Statin = 1 and other_lipid_lowering = 1 then 1 end)          as statin_plus_other_lipid_l,
       sum(case when High_Intensity_Statin = 1 and Ezetimibe = 1 then 1 end)      as high_intensity_statin_ezetimibe,
       sum(case when Statin = 1 and other_lipid_lowering_ex_omega = 1 then 1 end) as statin_plus_other_lipid_l_Ex_omega
        ,
       sum(no_lipid_lowering_ex_omega)                                            as no_lipid_lowering_ex_omega
       --sum(less_than_3_months_therapy) as less_than_3_months_therapy
       --  sum(max(Statin,Ezetimibe, bile_acid_sequestrant,fibrate, pcsk9,icosapent_ethyl, niacin, omega_3 ))

from shtg_meds_Q2_v2
group by cohort;
/*
--table 8
select sum(Statin)                                              Statin,
       sum(High_Intensity_Statin)                               High_Intensity_Statin,
       sum(Ezetimibe)                                           Ezetimibe,
    /* sum(bile_acid_sequestrant)              bile_acid_sequestrant,
     sum(fibrate)                            fibrate,
     sum(pcsk9)                              pcsk9,
     sum(omega_3)                            omega_3,
     sum(niacin)                             niacin,
     sum(icosapent_ethyl)                    icosapent_ethyl,
     */sum(Statin * Ezetimibe)                           as statin_ezetimibe,
       sum(Statin * pcsk9)                               as     statin_pcsk9,
       sum(Statin * Ezetimibe * pcsk9)                   as     statin_ezetimibe_pcsk9,
       sum(statin * other_lipid_lowering)                as     statin_plus_other_lipid_l,
       sum(High_Intensity_Statin * other_lipid_lowering) as     high_intensity_statin_plus,
       sum(no_lipid_lowering)                            as     no_lipid_lowering,
       sum(less_than_3_months_therapy)                   as     less_than_3_months_therapy,
       sum(ldl_above_70)                                 as     total_count,
       'ldl_above_70'                                    as     lipid_status


       --  sum(max(Statin,Ezetimibe, bile_acid_sequestrant,fibrate, pcsk9,icosapent_ethyl, niacin, omega_3 ))
from shtg_meds_Q2_d2
group by ldl_above_70
having ldl_above_70 = 1
union
select sum(Statin)                                              Statin,
       sum(High_Intensity_Statin)                               High_Intensity_Statin,
       sum(Ezetimibe)                                           Ezetimibe,
    /* sum(bile_acid_sequestrant)              bile_acid_sequestrant,
     sum(fibrate)                            fibrate,
     sum(pcsk9)                              pcsk9,
     sum(omega_3)                            omega_3,
     sum(niacin)                             niacin,
     sum(icosapent_ethyl)                    icosapent_ethyl,
     */sum(Statin * Ezetimibe)                           as statin_ezetimibe,
       sum(Statin * pcsk9)                               as     statin_pcsk9,
       sum(Statin * Ezetimibe * pcsk9)                   as     statin_ezetimibe_pcsk9,
       sum(statin * other_lipid_lowering)                as     statin_plus_other_lipid_l,
       sum(High_Intensity_Statin * other_lipid_lowering) as     high_intensity_statin_plus,
       sum(no_lipid_lowering)                            as     no_lipid_lowering,
       sum(less_than_3_months_therapy)                   as     less_than_3_months_therapy,
       sum(ldl_above_100)                                as     total_count,

       'ldl_above_100'


       --  sum(max(Statin,Ezetimibe, bile_acid_sequestrant,fibrate, pcsk9,icosapent_ethyl, niacin, omega_3 ))
from shtg_meds_Q2_d2
group by ldl_above_100
having ldl_above_100 = 1
union
select sum(Statin)                                              Statin,
       sum(High_Intensity_Statin)                               High_Intensity_Statin,
       sum(Ezetimibe)                                           Ezetimibe,
    /* sum(bile_acid_sequestrant)              bile_acid_sequestrant,
     sum(fibrate)                            fibrate,
     sum(pcsk9)                              pcsk9,
     sum(omega_3)                            omega_3,
     sum(niacin)                             niacin,
     sum(icosapent_ethyl)                    icosapent_ethyl,
     */sum(Statin * Ezetimibe)                           as statin_ezetimibe,
       sum(Statin * pcsk9)                               as     statin_pcsk9,
       sum(Statin * Ezetimibe * pcsk9)                   as     statin_ezetimibe_pcsk9,
       sum(statin * other_lipid_lowering)                as     statin_plus_other_lipid_l,
       sum(High_Intensity_Statin * other_lipid_lowering) as     high_intensity_statin_plus,
       sum(no_lipid_lowering)                            as     no_lipid_lowering,
       sum(less_than_3_months_therapy)                   as     less_than_3_months_therapy,
       sum(nhdl_above_100)                               as     total_count,
       'nhdl_above_100'


       --  sum(max(Statin,Ezetimibe, bile_acid_sequestrant,fibrate, pcsk9,icosapent_ethyl, niacin, omega_3 ))
from shtg_meds_Q2_d2
group by nhdl_above_100
having nhdl_above_100 = 1
union
select sum(Statin)                                              Statin,
       sum(High_Intensity_Statin)                               High_Intensity_Statin,
       sum(Ezetimibe)                                           Ezetimibe,
    /* sum(bile_acid_sequestrant)              bile_acid_sequestrant,
     sum(fibrate)                            fibrate,
     sum(pcsk9)                              pcsk9,
     sum(omega_3)                            omega_3,
     sum(niacin)                             niacin,
     sum(icosapent_ethyl)                    icosapent_ethyl,
     */sum(Statin * Ezetimibe)                           as statin_ezetimibe,
       sum(Statin * pcsk9)                               as     statin_pcsk9,
       sum(Statin * Ezetimibe * pcsk9)                   as     statin_ezetimibe_pcsk9,
       sum(statin * other_lipid_lowering)                as     statin_plus_other_lipid_l,
       sum(High_Intensity_Statin * other_lipid_lowering) as     high_intensity_statin_plus,
       sum(no_lipid_lowering)                            as     no_lipid_lowering,
       sum(less_than_3_months_therapy)                   as     less_than_3_months_therapy,
       sum(nhdl_above_130)                               as     total_count,

       'nhdl_above_130'
--  sum(max(Statin,Ezetimibe, bile_acid_sequestrant,fibrate, pcsk9,icosapent_ethyl, niacin, omega_3 ))
from shtg_meds_Q2_d2
group by nhdl_above_130
having nhdl_above_130 = 1
union
select sum(Statin)                                              Statin,
       sum(High_Intensity_Statin)                               High_Intensity_Statin,
       sum(Ezetimibe)                                           Ezetimibe,
    /* sum(bile_acid_sequestrant)              bile_acid_sequestrant,
     sum(fibrate)                            fibrate,
     sum(pcsk9)                              pcsk9,
     sum(omega_3)                            omega_3,
     sum(niacin)                             niacin,
     sum(icosapent_ethyl)                    icosapent_ethyl,
     */sum(Statin * Ezetimibe)                           as statin_ezetimibe,
       sum(Statin * pcsk9)                               as     statin_pcsk9,
       sum(Statin * Ezetimibe * pcsk9)                   as     statin_ezetimibe_pcsk9,
       sum(statin * other_lipid_lowering)                as     statin_plus_other_lipid_l,
       sum(High_Intensity_Statin * other_lipid_lowering) as     high_intensity_statin_plus,
       sum(no_lipid_lowering)                            as     no_lipid_lowering,
       sum(less_than_3_months_therapy)                   as     less_than_3_months_therapy,

       sum(TG_above_150)                                 as     total_count,
       'TG_above_150'


       --  sum(max(Statin,Ezetimibe, bile_acid_sequestrant,fibrate, pcsk9,icosapent_ethyl, niacin, omega_3 ))
from shtg_meds_Q2_d2
group by TG_above_150
having TG_above_150 = 1
union
select sum(Statin)                                              Statin,
       sum(High_Intensity_Statin)                               High_Intensity_Statin,
       sum(Ezetimibe)                                           Ezetimibe,
    /* sum(bile_acid_sequestrant)              bile_acid_sequestrant,
     sum(fibrate)                            fibrate,
     sum(pcsk9)                              pcsk9,
     sum(omega_3)                            omega_3,
     sum(niacin)                             niacin,
     sum(icosapent_ethyl)                    icosapent_ethyl,
     */sum(Statin * Ezetimibe)                           as statin_ezetimibe,
       sum(Statin * pcsk9)                               as     statin_pcsk9,
       sum(Statin * Ezetimibe * pcsk9)                   as     statin_ezetimibe_pcsk9,
       sum(statin * other_lipid_lowering)                as     statin_plus_other_lipid_l,
       sum(High_Intensity_Statin * other_lipid_lowering) as     high_intensity_statin_plus,
       sum(no_lipid_lowering)                            as     no_lipid_lowering,
       sum(less_than_3_months_therapy)                   as     less_than_3_months_therapy,

       sum(ldl_under_70_nhdl_above_100_TG_above_150)                                 as     total_count,
       'ldl_under_70_nhdl_above_100_TG_above_150'


       --  sum(max(Statin,Ezetimibe, bile_acid_sequestrant,fibrate, pcsk9,icosapent_ethyl, niacin, omega_3 ))
from shtg_meds_Q2_d2
group by ldl_under_70_nhdl_above_100_TG_above_150
having ldl_under_70_nhdl_above_100_TG_above_150 = 1
union

select sum(Statin)                                              Statin,
       sum(High_Intensity_Statin)                               High_Intensity_Statin,
       sum(Ezetimibe)                                           Ezetimibe,
    /* sum(bile_acid_sequestrant)              bile_acid_sequestrant,
     sum(fibrate)                            fibrate,
     sum(pcsk9)                              pcsk9,
     sum(omega_3)                            omega_3,
     sum(niacin)                             niacin,
     sum(icosapent_ethyl)                    icosapent_ethyl,
     */sum(Statin * Ezetimibe)                           as statin_ezetimibe,
       sum(Statin * pcsk9)                               as     statin_pcsk9,
       sum(Statin * Ezetimibe * pcsk9)                   as     statin_ezetimibe_pcsk9,
       sum(statin * other_lipid_lowering)                as     statin_plus_other_lipid_l,
       sum(High_Intensity_Statin * other_lipid_lowering) as     high_intensity_statin_plus,
       sum(no_lipid_lowering)                            as     no_lipid_lowering,
       sum(less_than_3_months_therapy)                   as     less_than_3_months_therapy,

       sum(ldl_under_70_nhdl_above_100)                                 as     total_count,
       'ldl_under_70_nhdl_above_100'


       --  sum(max(Statin,Ezetimibe, bile_acid_sequestrant,fibrate, pcsk9,icosapent_ethyl, niacin, omega_3 ))
from shtg_meds_Q2_d2
group by ldl_under_70_nhdl_above_100
having ldl_under_70_nhdl_above_100 = 1
--order by ldl_above_70, ldl_above_100, nhdl_above_100, nhdl_above_130, TG_above_150
;

*/